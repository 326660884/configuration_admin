<div class="layuimini-container layuimini-page-anim">
    <div class="layuimini-main">

        <fieldset class="table-search-fieldset">
            <legend>搜索信息</legend>
            <div style="margin: 10px 10px 10px 10px">
                <form class="layui-form layui-form-pane" action="">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">用户名</label>
                            <div class="layui-input-inline">
                                <input type="text" name="userName" autocomplete="off" class="layui-input">
                            </div>
                        </div>


                        <div class="layui-inline">
                            <button type="submit" class="layui-btn layui-btn-primary"  lay-submit lay-filter="data-search-btn"><i class="layui-icon"></i> 搜 索</button>
                        </div>
                    </div>
                </form>
            </div>
        </fieldset>

        <br>
        <div class="layui-btn-container">
            <button id= "add" class="layui-btn layui-btn-normal layui-btn-sm data-add-btn" lay-event="add"> 添加 </button>
        </div>


        <table id = "currentTableId" class="layui-table"></table>
        <div id = "divPage"></div>


    </div>
</div>

<script>
    layui.use(['form', 'table','miniPage','element','laypage'], function () {
        var $ = layui.jquery,
            form = layui.form,
            table = layui.table,
            laypage = layui.laypage,
            miniPage = layui.miniPage;


        function unique(arr){
            var hash=[];
            for (var i = 0; i < arr.length; i++) {
                if(hash.indexOf(arr[i])===-1){
                    hash.push(arr[i]);
                }
            }
            return hash;
        }

        function col2Row(data){
            var userList = [];
            var _clientList = [];
            var clientList;
            var list = data.page.list;

            for(var i = 0 ;i<list.length;i++){
                userList[i] = list[i].userName;
                _clientList[i] = list[i].appName;
            }

            clientList = unique(_clientList);


            var temp = {};
            for (var j = 0; j < userList.length; j++) {
                var arr = temp[userList[j]]
                if (arr) {
                    arr.push(_clientList[j])
                } else {
                    arr = [_clientList[j]]
                }
                temp[userList[j]] = arr
            }
            console.log(temp);


            ht = "<tr><th></th>"
            for (var k = 0; k < clientList.length; k++) {
                var h = '<th>' + clientList[k] + '</th>';
                ht += h
            }
            ht += "</tr>"
            for (var index in temp)  {
                ht += "<tr><td>" + index + "</td>"
                for (var m = 0; m < clientList.length; m++) {
                    if (temp[index].indexOf(clientList[m])!==-1) {
                        ht += "<td>√</td>"
                    } else {
                        ht += "<td></td>"
                    }
                }
                ht += "</tr>"
            }
            document.getElementById("currentTableId").innerHTML += ht
        }


        $(function () {
            $.ajax({
                type:"GET",
                url:"/configuration/applist/list",
                data:{ page: 1, limit: 10 },
                dataType:"json",
                success:function (res) {
                    col2Row(res);
                    laypage.render({
                        elem: 'divPage'
                        ,count: res.page.totalCount
                        ,limit:10
                        ,limits:[10,15,20,25,50,100]
                        ,layout: ['count', 'prev', 'page', 'next', 'limit', 'skip']
                        ,jump: function(obj,first){
                            if (!first) {
                                $.ajax({
                                    type:"GET",
                                    url:"/configuration/applist/list",
                                    data:{ page: obj.curr, limit: obj.limit},
                                    dataType:"json",
                                    success:function (res) {
                                        document.getElementById("currentTableId").innerHTML = '';
                                        col2Row(res)
                                    }

                                });
                            }
                        }
                    });

                }

            });
        });





        // table.render({
        //     elem: '#currentTableId',
        //     url: '/configuration/applist/list',
        //     parseData: function(res){ //res 即为原始返回的数据
        //         return {
        //             "code": res.code, //解析接口状态
        //             "msg": res.msg, //解析提示文本
        //             "count": res.page.totalCount, //解析数据长度
        //             "data": res.page.list //解析数据列表
        //         };},
        //     toolbar: '#toolbarDemo',
        //     defaultToolbar: ['filter', 'exports', 'print', {
        //         title: '提示',
        //         layEvent: 'LAYTABLE_TIPS',
        //         icon: 'layui-icon-tips'
        //     }],
        //     cols: [[
        //         {type: "checkbox", width: 50},
        //         {field: 'userName', width: 200, title: '用户名'},
        //         {field: 'clientId', width: 150, title: '应用名'},
        //         {title: '操作', minWidth: 150, toolbar: '#currentTableBar', align: "center"}
        //     ]],
        //     limits: [10, 15, 20, 25, 50, 100],
        //     limit: 10,
        //     page: true,
        //     skin: 'line'
        // });

        // 监听搜索操作
        form.on('submit(data-search-btn)', function (data) {
            //var res = JSON.stringify(data.field);
            console.log(data.field.userName);

            $.ajax({
                type:"GET",
                url:"/configuration/applist/list",
                data:{ page: 1, limit: 10 ,userName:data.field.userName},
                dataType:"json",
                success:function (res) {
                    document.getElementById("currentTableId").innerHTML = '';
                    col2Row(res);
                    laypage.render({
                        elem: 'divPage'
                        ,count: res.page.totalCount
                        ,limit:10
                        ,limits:[10,15,20,25,50,100]
                        ,layout: ['count', 'prev', 'page', 'next', 'limit', 'skip']
                        ,jump: function(obj,first){
                            if (!first) {
                                $.ajax({
                                    type:"GET",
                                    url:"/configuration/applist/list",
                                    data:{ page: obj.curr, limit: obj.limit,userName:data.field.userName},
                                    dataType:"json",
                                    success:function (res) {
                                        document.getElementById("currentTableId").innerHTML = '';
                                        col2Row(res)
                                    }

                                });
                            }
                        }
                    });



                }

            });



            // layer.alert(res, {
            //     title: '最终的搜索信息'
            // });

            //执行搜索重载
            // table.reload('currentTableId', {
            //     page: {
            //         curr: 1
            //     },
            //     where:data.field
            //
            // }, 'data');

            return false;
        });





        //添加
        $("#add").click(function () {
            var content = miniPage.getHrefContent('page/table/add-appList.html');
            var openWH = miniPage.getOpenWidthHeight();

            var index = layer.open({
                title: '添加项目权限',
                type: 1,
                shade: 0.2,
                maxmin:true,
                shadeClose: true,
                area: [openWH[0] + 'px', openWH[1] + 'px'],
                offset: [openWH[2] + 'px', openWH[3] + 'px'],
                content: content,
                end: function(){
                    location.reload();
                }
            });
            $(window).on("resize", function () {
                layer.full(index);
            });
        });

        /**
         * toolbar事件监听
         */
        table.on('toolbar(currentTableFilter)', function (obj) {
            if (obj.event === 'add') {   // 监听添加操作
                var content = miniPage.getHrefContent('page/table/add-appAuthentication.html');
                var openWH = miniPage.getOpenWidthHeight();

                var index = layer.open({
                    title: '添加项目权限',
                    type: 1,
                    shade: 0.2,
                    maxmin:true,
                    shadeClose: true,
                    area: [openWH[0] + 'px', openWH[1] + 'px'],
                    offset: [openWH[2] + 'px', openWH[3] + 'px'],
                    content: content,
                    end: function(){
                        location.reload();
                    }
                });
                $(window).on("resize", function () {
                    layer.full(index);
                });
            } else if (obj.event === 'delete') {  // 监听删除操作
                var checkStatus = table.checkStatus('currentTableId')
                    , data = checkStatus.data
                    ,len = data.length
                    ,tokens = []
                    ,url = '';


                for (var i = 0; i < len; i++) {
                    tokens[i] = data[i]['appToken']
                };

                layer.confirm('确定删除吗？',function(index){
                    $.ajax({
                        type: "POST",
                        url: url,
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(tokens),
                        dataType: "json",
                        success: function (res) {
                            if (res.code== 0) {
                                layer.msg("删除成功");
                                table.reload('currentTableId',{});
                                layer.close(index);
                            }
                        },
                        error: function (res) {
                            layer.msg("删除失败");
                        }
                    });
                });

            }
        });

        //监听表格复选框选择
        table.on('checkbox(currentTableFilter)', function (obj) {
            console.log(obj)
        });

        table.on('tool(currentTableFilter)', function (obj) {
            var data = obj.data;
            if (obj.event === 'edit') {
                $.get(""+data.appToken,function(res){
                    var content = miniPage.getHrefContent('page/table/edit-appAuthentication.html');
                    var openWH = miniPage.getOpenWidthHeight();

                    var index = layer.open({
                        title: '编辑用户',
                        type: 1,
                        shade: 0.2,
                        maxmin:true,
                        shadeClose: true,
                        area: [openWH[0] + 'px', openWH[1] + 'px'],
                        offset: [openWH[2] + 'px', openWH[3] + 'px'],
                        content: content,
                        success: function(layero,index){
                            form.val("dataFrm",res.appAuthentication)
                        },
                        end: function(){
                            //location.reload()
                            table.reload('currentTableId',{});
                        }


                    });

                    $(window).on("resize", function () {
                        layer.full(index);
                    });
                });
                return false;

            } else if (obj.event === 'delete') {
                var url = '';

                layer.confirm('真的删除行么', function (index) {

                    $.ajax({
                        type: "POST",
                        url: url,
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify([data.appToken]),
                        dataType: "json",
                        success: function (res) {
                            if (res.code == 0) {
                                layer.msg("删除成功");
                                obj.del();
                                layer.close(index);
                            }
                        },
                        error: function (res) {
                            layer.msg("删除失败");
                        }
                    });


                });
            }
        });

    });
</script>